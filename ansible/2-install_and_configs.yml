- name: Update and reboot for freshness
  hosts: dev_all
  remote_user: ubuntu
  sudo: true
  tasks:
  
  - name: dist upgrade
    apt: upgrade=dist
    with_items: ec2.dev_all
  
  - name: reboot to make sure everything is fresh
    shell: /sbin/reboot &
    with_items: ec2.dev_all

  - name: wait for the server to go down (reboot)
    local_action: wait_for host={{ item.public_ip }} port=22 state=stopped
    with_items: ec2.dev_all

  - name: Wait for the server to wake back up
    local_action: wait_for host={{ item.public_ip }} port=22 delay=30
    with_items: ec2.dev_all

# DATABASE: Ensure our database tier is running correctly
- name: Deploy Initial Configs: DB.
  hosts: dev_db
  remote_user: ubuntu
  sudo: true
  pre_tasks:

  - name: set up jumphost for DB subnet
    connection: local
    shell: echo "I haven't figured out how to pull this off quite yet."

  # Install Java 7
  - name: ensuring add-apt-repository is installed
    apt: pkg=python-software-properties state=latest
    tags: java
   
  - name: adding webupd8 ppa for java7 installer
    apt_repository: repo=ppa:webupd8team/java
    tags: java
   
  - name: updating apt cache
    apt: update_cache=yes cache_valid_time=3600
    tags: java
   
  - name: installing java7
    # Installer is interactive so force all answers to yes.
    # http://askubuntu.com/a/190674/67778
    shell: echo debconf shared/accepted-oracle-license-v1-1 select true |
           debconf-set-selections && 
           echo debconf shared/accepted-oracle-license-v1-1 seen true | 
           debconf-set-selections &&
           apt-get -y install oracle-java7-installer
    tags: java

  roles:

  - common
  - db

# PROXY: Ensure we have a local proxy ready to route requests
- name: Virtual server proxies
  hosts: dev_proxy
  remote_user: deploy
  
  roles:
    - role: proxy